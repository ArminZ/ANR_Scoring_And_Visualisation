//using AirNavigationRaceLive.Migrations;
using AirNavigationRaceLive.Migrations;
using AirNavigationRaceLive.Model;
using System;
using System.Collections.Generic;
using System.Data.Entity;
using System.Data.Entity.Infrastructure;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AirNavigationRaceLive.Client
{
    public class CustomDbInitializer<TContext> : IDatabaseInitializer<TContext>
        where TContext : DbContext
    {
        #region CON_SQL various string constants
        const string CON_SQL_Check_Existence_MigrationHistory = @"(SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = '__MigrationHistory')";
        const string CON_SQL_Check_Existence_CompetitionSet = @"(SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'CompetitionSet')";
        const string CON_SQL_Add_MigrationHistory_Table = @"IF NOT EXISTS (
                        SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[__MigrationHistory]') AND type in (N'U'))
                        BEGIN
                        CREATE TABLE [dbo].[__MigrationHistory](
	                    [MigrationId] [nvarchar](150) NOT NULL,
	                    [ContextKey] [nvarchar](300) NOT NULL,
	                    [Model] [varbinary](max) NOT NULL,
	                    [ProductVersion] [nvarchar](32) NOT NULL,
                     CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY CLUSTERED 
                    (
	                    [MigrationId] ASC,
	                    [ContextKey] ASC
                    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, 
                        IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
                    ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
                    END";
        const string CON_SQL_Add_InitialRow_MigrationHistory = @"INSERT [dbo].[__MigrationHistory] ([MigrationId], [ContextKey], [Model], [ProductVersion]) VALUES (N'201707062312047_Initial', N'AirNavigationRaceLive.Migrations.Configuration', 0x1F8B0800000000000400ED5D5B6F1BBB117E2FD0FF20E8A92D722C3B69CE25B0CF81E42445D0244A2DE720790AD612652FBA17757715D8A7E82FEB437F52FF42B9772EC92187CBBD48A95F0C6B971C72861F8743CEECF0BFFFFECFF92FF7BE37F94AA2D80D838BE9D9C9E974428275B87183DB8BE93ED97EF7E3F4979F7FFFBBF3571BFF7EF26B59EE595A8ED60CE28BE95D92EC5ECC66F1FA8EF84E7CE2BBEB288CC36D72B20EFD99B309674F4F4F7F9A9D9DCD082531A5B42693F3AB7D90B83EC97ED09F9761B026BB64EF78EFC20DF1E2E2397DB3CAA84EDE3B3E8977CE9A5C4CE76EF4DEF9EADE3A09EDC9157DF4D6FD4A4EB27AD3C9DC731DDAA515F1B6D38913046192157BF13126AB240A83DBD58E3E70BCEB871DA1E5B68E179382911775712C4FA74F539E6675C592D47A1F27A16F48F0EC5921A4195FBD95A8A79510A9185F5171270F29D799282FA697A1BF23F419A5BE22C974C237F9E2D28BD2E24A799F34A93C9948CB3EA960737642F17572FA6472B9F7927D442E02B24F22C77B32F9B0BFF1DCF55FC9C375F877125C3CDFAC9F6E9FADBFFFF1A7E7373F3C3FFB81E5857243CB351ED0471FA27047A2E4E18A6C0B0EDF6CA69359B3DE8CAF585563EAE45CBF0992674FA793F77BCF736E3C52418591D02A0923F2171290C849C8E6839324240A521A2413B6D03AD756FAB76C8D6293CEB7E9E49D73FF9604B7C9DDC594FE3B9DBC76EFC9A67C52F4E063E0D2E9492B25D19E487AC8B55A8F07D7FE3B67978DFC15F1B2D7F19DBBCB670E37AC5FCA92AFA3D0BF0A3D013D45812FAB701FAD539E4255A96B27BA4DA961FBF9C189D69430B2AF6C69B0BF75215D9F9992A6FDFE1BD566EED65DE77321DC071B240B4045901B69791D63F24AA63CAEF637F13A726F087678B80A204F8D723A5E9A854D79B8268E8FEC7D5514EC775142D7E3B298ACAFE7B35A592B5578392DDBA9EEBCF6A3CA3E4095CDB5FA69E5FE5635FB32A46237A7F1B9031A9FAEC2C4B61BF6243E5D87BBB7646BDD936EC87C70D7E9ACF8A247A19A0EA31FCC6981AA8D37F2BA5BEA4BC5A55EEA4B2DD8D1525F50952FF1C24B41078B258C4D917CB4A1FED5AF2572145E0A32144BC8E4875E1E5831B55B226A0A8FCB4487CBC4F353CD2A51FC365421736F77E7D869210ABB6F4693996E04341A4DA257B07D7FEB0644AE2F6A9A7919465B345F09BA8C7F6FAAC9149B3F432DCBCB0DD6C3DD6F9C9846B49B265D599588F19B25B476CE07BC9D5E4EEB3E6A64138D9CB663A7D6E6D68A71614D61694DA1C074A632B23F0241EC249DCB2764E806C9977963DEE58F446BA7786EAA1D168A861762C30BA0E18571C34B45C34BB1E125D0F0B26BABD86015117A04AC32DD6BEA8CBC5647C3A504EDAC286AA597B3416A6D30A7951F35B38966763C5A6ABFB13D9BF0C2E0B6133A4E27DDB9767D12278EBF6304F9FD9F8DC9BCF6DCDBBB6440252DD8409CF2EE4D49CB1B5E18379C4B0CD242D5DB2FC534AF3BC2BD125425FFBEF7D5432E91A59D7663C4D34EC355041EB59C8996A36B53626980A62AE5DAF93B596EB7764A2525B44A9C28C9AD055B52AF828D3DA1AC3F6F5EDA4948B406ACEDE5D44FD3E129C60712D0F5EE01A19E9882521D55BD17F484B490F14167AE1EED54A8A2670D15DBBDB529B70B19E557775A5354580774E54DD70595F7B1F4124A3B2EBC14BA2A96B03B4F6630D9D23CAE283CAE1E26AB47365D623B4D76459C380D24529C4AF7732C0DD9B0AD9528DAC4C3EB5085B1272ADA569307D05DEDE69194D8E3943A7C178D956F845F38725B507E8AD7EE5870547F4D37514F1A2F8EFA6CA91B0DD4A1F1C15B505863A5FB93457BF78AE2ECB19B516126443F47903C0788D3CA566B456512B65B1D8AEA8FEB81C97A70F97EEFDF90A8832541B70278A1AA95B34E5A799FC9840233657CE870B5F9E5F06D7E70BDB0858D29882D9B2DA164213C8E98077C7CAA669DE4C358BB59190DF7B3FCEA07EF78B1DDAB0658D93DA694D8BD1A2350F7EA12E6E1655E28971C17E12C0EB3B48030CAF252568B1517D0DD6EC96A10795CB84C16AEB74E9C8C1396FCDA8DC66ABACB7D1418C1DB9F9A6EF711844665CBBF98E83EB215EC3C544615E76AD769D5D9694B8DC92B75B55E6D778ECA88BAE5396A45E151579AE8CA974E5205C82EDCC0891E70CAAA8F4FEC0C63C5056F30184DDEDDA75B56935ED161FDE75AD05C9AC771B876B37EB247E35FE61C5A5F059B0910D890AF5495EF9D02804E0C7747A7026D8FEEBF04018AB42A7D56D3CA0F1D9AA4FE2490A233854429541DEF924A9ACE434A509C566EB076778E27E7802B8E9C87A9482BC2FC9B97644782740AC9F9C4B49847478A6D56A439ADA093C4F98C196A0C02161A042C3A44C06214042C0647C0C204018BF1102075F94043A8F6A1D7E3C9EC51797CF03C2E8397C4230999CCD769AFA865E6C46B6723AE1354AB6D8CFA25C119EBD5EA056D2A010D003D951C30CD33EEC6B1C1986917C47837832510103C3D39E91F85CD28388DD2EC1E7BAC5086851DCBF831204EE76F82C61AED7CAAC71EF09E0CA220D1813A8809D4115C91121C00BE48E1607A0244D18D026DF1C0184287E2F4B8C643750A80B7F8145156C3E10C646E00648102C0B45D854F8EB33310B6D8A05D0FEFB799858F39B71944E329BE18AF7B551E1EF4B3F380E432C41E04E21ED3367BA83B36F69A672788C1060E523048CC2C43C5FE557B445B37C21DF9F48D2F29D3C3C24C2A92A3409BFCB01B4281E6E41B09819E949EC691A95DCC3B42A6524603C05229061C26CB8888512DB7DA97AEB3B0248EF51683ADA26BAAE4A4CAD4CA8013FA32A00127C817D376332266C4F3DDA5E67C77D9E1F9EE7294F3DDE5E0E7BB4B13142EC743802270131A48CC87E4EAB1ED6979C384971A9EB7748442BDC80600A65E3CA86D27171A3F8EDEE2D232803A07CAF4C3E831264CDBCCDE87F23F0CA3D7E49C0DA1DFE47CA3EC26598694B10164A6FCF0998E301043E2EB20751A5612C342D25ABFB19FEB8C024D3145188410455646DD19960A788A3464184C77042F90B901F0044A00D37699E76F14F0C8338E4223ADC9345E8F361F86398839A7498E3AD031AD524603605129054CFB7C3CEF21E012A1DC1059E50F0B9F23EB4BADBC86C76A3BFD79887835B311CDAE10382C141FA4A96922D0E1616E6D721E22E2718E35DCC5128785F08370CE6104373C925B3BE90E11C13A4F9DEE72113C6AE1AD94EE03D1A13C6E6A5E87075A0B9FDB0810CBBF93A075125A834465387E1079C58568C217461F63527C6414175FDFF1C8482952CE81CFDBEA2F3300E809486BD22B7742029DF285A63E6BA50A34D8971A3AF9C1A740217FACEB43EE58129BCF9F6B6A33E1620205E69DAE0F4C20B8D811E6A5860E6024092481721AEA95CE10E8556F3414B8A54EA0C3BDD7498D099D11A5C6BCE4E830D38F83419A489579CBE558E53500FC6552D5D30A5E82FA803F45622A4B013C6BF61FCDDB02E66DA1E56D61C3DBA247DEE439C24446F51F96343AAEFCB484E1029CE37A6A129928A6BA9564F271520A45FCC001E2A0F189838D281A5F25E860D54200DAE44DA2408CE2EF1B7C6123F0193E515AD8A8118930E145C85CA0929C1FA2083571DE0D7EE0486F86036071D110EA5914924F7E25CA551DB4DCD49460D8323B33C0454D434B220DC044B31205B77E2B25A2D8F143CCC8F7FB56F291EFCE19926A93C45C5A402E0351548838D00653EA48502C470892122141F65F7B15C3E4ED81550C109028D50C6248624B1523C620F688962AA73C64B92DB596DBD2C6725BF668B9A972F889EC6203C71A4C2042C7347C61C949C484DB64B5C0047F478C041BAA78A5E63003114B2C56C07DB892528FDB196D2A4BA5444C41840EC1B192D9E8B0925C15278A51132CD2600E0E17D15A211A3AB23D037C58642E0AE01E55511C88F007D5F92C6CE8A9CFE11034FB34F81497336A4584428EDE17DF89A8C643145A6D99FB85DB7B863B91E9E86A4C9D9E4D2B61ECAE04E589EC44A283EF50A03CA45AD9E9F7281A1F5827F2EA749B5226AFAA9C32D5BBF3D96A7D477CA778703EA345D66497505867DE9AB87C41D5EECE0D6EE3BA66F164B2DA39EBB4FFDFADA6937BDF0BE28BE95D92EC5ECC6671463A3EF1DD7514C6E136395987FECCD984B3A7A7A73FCDCECE667E4E63B68E5971F32EA4AA25BA5D716E09F73615DD8664A91FD36C6A374E9A0EED72E30BC56A171470205FB623F5328923571ED597D5D2FF0B679722539E9A6C2DD7D794553F75056619E6604C09042889D5DAF19C4892D6EE32F4F67E00FB26E1DA79564DB67EFE44A4703EE338105C8E82E884A884E680A0860BB45ADA0D939C1C6278A08A630F0B44E1D3CAFD8D23513CC2D3F82CD2F86C4AE3D3559A68B8D18DEC89412F040A9F0D297CBA0E776FC996EF47F5D4A02F524A9F5B5062BFE46669A9BEF086A9F1F1002C455DACC068535B696DB79BDE3049C41457553ED4693EF776774E9344F1084FA38CD167894071FB3095A3842070FED40E7C326208D8C9ABF503B8949166FDFC8901E084C19567E484292C040AF28C8E3085A54041FECD304C41FAED5D430D633ECE1B4F7302FEF0964A53460DA32FE5F5FA416E7D7B334BA37E8AA7C45CE0CC92621E1BD07264BDAA9F1ACCCCFA1EE7C6F4AC1FE369317902595A8AF481A32159E5876F8766902202D18ABAFDA0BAB8AD9725503C32434E755D2F8F9DEA85193DE6D65E9E22F3CA8CE6ABF2FA5E9E62F5024FAFBAC597A5553DC4D3015210B25491590A15BC97A9E91A7C43F9EAC65B535481672D1716902466755154EE673296979F36EC80E299C1942EAE3F6DCCE9E2D937A9C2B1C7FEED3084A28E801392CEA1EEF3EC7657A06AE2D29734349426B5094C954D1A20B1A90F0BBDB05BA01D5E017A08848235FBC164750F61034AE543136466F70C3601993D32991FA9248B5B049BD3847961B049BDE4B6A8976647736542BBE6C11C94E64EC5179BD4ACC9982ADD994ADA4778CAA2735BB69B694AAA88F9A6A9DFCFACAB2F516369D44F0D2C84FA52B48685503F1E7B756977C43D96F95B07E77666FE822431E6AFA2723FD0CCEFAC62EBE74F061E22C1A9CD17A95A2F9E54BF2BA776E1506E78BA33AE53BF75C66D5C38B7790F735E643AA1A2F9EA6E52EFF2EA214E887F92163859FDC3BBF45C92C6A69605DE3981BB2571925F6D367D7A7AF6743A997BAE13E7510885EFFC05FF7124CA997EF62C75A6938D3FE3AB9BBBE4532A71BC6938C9C51BE3544EE8216E66CBE27EB577AF195FB65BDF1C197CA546E89D13FDC177EEFFA8A184BE674F9A58E8FF4D5A22A5C2DF9C93DA7AA1931893F86C4F2277375B75C29A42ED6AB6EA472754C45B483318095F6FBF0936E4FE62FACFACDA8BC99B4F5FEA9A4F26CB882ABF1793D3C9BF3ABA5215DB89666D838EE06FCD84D2317D0B33BA98D0C27DF3A637AFE73E66A6D386044AFFB2D9E0E7B5BE69F44932B81E2BEE72D7727B8CCC5B0CD0DC161F8B168D2E6C1B5DB6687469DBA8D4C56DB8228824A02EE5B76FB753C892EBED8E754ED40E6B9B359CF1555B9171BAE80CE3A2CEC9DCB8B76DA63BE3DB30436155B107EC41F7811D2BFE0AEF727BA5DC702A5B8D37E74CB6A655B991AD28554EE4F622023CC666A09612B1D2F795CBD9AC2345B55E2C6DE812DD639D5DA5B7B83D764A4FB1CA5A3737D7FB53AD36C38FC9237AAC48E861CF35D2CE45A24838CFB0A13E69D4EEC2826D6FB8F6046C79B2C5638572E513C6A25934B76460CE5CC430C93363920D5F7117E797A9D7B80B3AB5E7D8F4BC2DAF6735479A8E66B30EB075F1B6F5C1682EF47C55A5F73DD6595BBB94BB8030E355EE82DCC12C657D1E86DB9C7800CEDFA34563EE49AEB4FD8D1B38D1838D0F0EBABD8FCB83C9A70CB2BBB48FDD5E0E7255DF5017A1A1DA917FE733E0CD8C8BC7B1ED6B6CE55F600D32B6FAD4A7B2FC9C8DA1629E0E735D3A930895C51CF3B817DCA83E6DE91C3BCAE07DB1354564FAD03092B80B5A2328BBF6B01F10E174D6514207ADDFC6468D51465D5DAA5BF31B617A829621C63B8218F64B8DCEE166866DE4F75C83DE5DAE075C951C881950E0960C9595330E32E06F2246C602F815DE3056AD3A01B334257073C1601E0FA258CA247D4C1F7ABD6E501941DD3976C0DC40624BAA10F6A1B183BB9CCA18429A0B9FB9BC6E0CC9216E8C1A1618BA2F4D0E101F88FCDCF683D993963158EB3A8293F9005B22CA6445843F3C1BD44601D299DBA348A3681ED1D0684AFDE1E080A771CBC7D338C361469FC6C9B3190D32B6D844F6A663D5D352D1D13EBC2324A107D81248ED77DABA8FFA87D11FAAFCFFD2FCF3C8CBA3352BC9A04A459588703CCD824A6B363408CCD48D312A5490382CFD312C68DA6B1155228F41C0A3B9E8A1CD89850A25C690EB080F060712B627F666C883B2838E71B3B1E6E88C4FD5CE8CDF28F76F0F7D84A6CD4B3EE631DA21DE948D502A8786A9B1F4D3F0D832D45387882F336BE7D0A0765806D3F0006C6F341D221671AE8343C3E0B8AE87E131677E1E798858D3F9202C50764887C7C3C3C3E4F478046070D99CAA8EF077FBF0435824889282A9BC374981913C93D3C5747313D2D1CFE38BD5D736096D9676B9D056F942D606708F1D4F9BB5CD04FAEC4B591B8ACBDFF876F2232EA185FCB18C76FA06C5407EA42FF63D7F2EED76FA0A439B894711E833EF646DC0B7680B0C30D19A2217CC4B292BCC7B4D3B803D2434099493B58EBB9D8EEF48A5F784A6AB37B2C6A06BC978F2DCDA2B34C2BD9735A5BE2B4E18402674411C40E6A57400C1BBB855571DCFE1AB8EE782AD2338C42A0630371CB31377D5E5F5B445283DC8C8E2481891C68D4BB8D2C79737BA2BE89E55F3620015ABA24A597199CC3B653B17BD9263E09E904E98C561A1058BBAA05C09CB4671BC980D2DC3164ADBDA88D5E2227AA55034D1A5724399E930E6DEF9FE5915A32465AA4B1D4AD904AEB06EACB884AB2A869B46E1AAD3AB8BC1A03E35C7D85B61ED1897AEEFAB3EAE7895C7AE4964800872EB8285B613C5625ED7C1568A790D44641D19CB65341168902C8FC4205184CE4878C306DA9877BD8FE5ADCDB872511EB2F1550582801E0E76B0C18DF030B6B42E8641CDB3E9E8DB09613C2488DE7A895C342EFD766BB09DF8EC6F27870D1684135B793ACA30607019799FC60BEC46D5B38F1AF56E4430020AD0BAC1DC53D88380C6D3134AE7945E5C5833B81B310D670E037E14BD40F4067137A2E8C63E14EE7DA8DE9DCFF213BCE201FD29DCEF703EBBDAD3DA7E9E23E4FC2589DDDB9AC439A5199075C333519579136CC3D251C2F5A82CC2E7AE2689B37112671E25EED65927F4F59AC4B11BDC4E27BF3ADE9E1679E5DF90CD9B60B94F76FB84B24CFC1BAF718351EA6851B57F3E13FA7CBEDCA5BFE22E58A0DD74290B64192CF6AEB7A9FAFD5A92810520917A708A0C31E9582669A698DB878AD2FB9037B1204285F82AC7D335F1771E25162F8395F395B4E9DBC798BC25B7CEFAA1BCA60326A21F88A6D8CF5FBACE6DE4F87141A3AE4F7F520C6FFCFB9FFF07D1B786B7ED0A0100, N'6.1.3-40302')";

        #endregion

        public void InitializeDatabase(TContext context)
        {
            if (!context.Database.Exists())
            {
                context.Database.CreateIfNotExists();
            }
            else
            {
                // this is either 
                // -an old database with no history table, or 
                // -a new table that has a history table

                //context.Database.CompatibleWithModel(true);
                // no metadata found in table because there is no history table
                // "Model compatibility cannot be checked because the database does not contain model metadata. 
                //  Model compatibility can only be checked for databases created using Code First or Code First Migrations."

                if (IsOldDBWithoutHistoryTable(context))
                {
                    try
                    {
                        // add the MigrationHistory table and the initial row
                        RunDBTransaction(CON_SQL_Add_MigrationHistory_Table);
                        RunDBTransaction(CON_SQL_Add_InitialRow_MigrationHistory);
                    }
                    catch (Exception ex)
                    {
                        string s = ex.InnerException.Message;
                        throw;
                    }
                    //Initial initialMigration = new Initial();
                    //initialMigration.IsOldFileWithoutMigrationHistory = true;
                    //initialMigration.Up();
                }

                // see  https://galleryserverpro.com/using-entity-framework-code-first-migrations-to-auto-create-and-auto-update-an-application/
                Configuration cf = new Configuration();
                var migrator = new System.Data.Entity.Migrations.DbMigrator(cf);
                if (migrator.GetPendingMigrations().Any())
                {
                    migrator.Update();
                }
            }


            // Do you want to migrate to latest in your initializer? Add code here!
            // Do you want to seed data in your initializer? Add code here!

        }

        /// <summary>
        /// Adding explicitly the __MigrationHistory table
        /// This is needed for old databases (compatible, but no versioning yet)
        /// </summary>
        private void CreateHistoryTable()
        {
            string str = @"IF NOT EXISTS (
                        SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[__MigrationHistory]') AND type in (N'U'))
                        BEGIN
                        CREATE TABLE [dbo].[__MigrationHistory](
	                    [MigrationId] [nvarchar](150) NOT NULL,
	                    [ContextKey] [nvarchar](300) NOT NULL,
	                    [Model] [varbinary](max) NOT NULL,
	                    [ProductVersion] [nvarchar](32) NOT NULL,
                     CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY CLUSTERED 
                    (
	                    [MigrationId] ASC,
	                    [ContextKey] ASC
                    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, 
                        IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
                    ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
                    END";
            RunDBTransaction(str);
        }

        /// <summary>
        /// Adding explicitly the first initial MigrationHistory row
        /// This is needed for old databases (compatible, but no versioning yet)
        /// After that, they are included in the versioning chain
        /// </summary>
        private void AddInitialRowToHistoryTable()
        {
            string str = @"INSERT [dbo].[__MigrationHistory] ([MigrationId], [ContextKey], [Model], [ProductVersion]) VALUES (N'201707062312047_Initial', N'AirNavigationRaceLive.Migrations.Configuration', 0x1F8B0800000000000400ED5D5B6F1BBB117E2FD0FF20E8A92D722C3B69CE25B0CF81E42445D0244A2DE720790AD612652FBA17757715D8A7E82FEB437F52FF42B9772EC92187CBBD48A95F0C6B971C72861F8743CEECF0BFFFFECFF92FF7BE37F94AA2D80D838BE9D9C9E974428275B87183DB8BE93ED97EF7E3F4979F7FFFBBF3571BFF7EF26B59EE595A8ED60CE28BE95D92EC5ECC66F1FA8EF84E7CE2BBEB288CC36D72B20EFD99B309674F4F4F7F9A9D9DCD082531A5B42693F3AB7D90B83EC97ED09F9761B026BB64EF78EFC20DF1E2E2397DB3CAA84EDE3B3E8977CE9A5C4CE76EF4DEF9EADE3A09EDC9157DF4D6FD4A4EB27AD3C9DC731DDAA515F1B6D38913046192157BF13126AB240A83DBD58E3E70BCEB871DA1E5B68E179382911775712C4FA74F539E6675C592D47A1F27A16F48F0EC5921A4195FBD95A8A79510A9185F5171270F29D799282FA697A1BF23F419A5BE22C974C237F9E2D28BD2E24A799F34A93C9948CB3EA960737642F17572FA6472B9F7927D442E02B24F22C77B32F9B0BFF1DCF55FC9C375F877125C3CDFAC9F6E9FADBFFFF1A7E7373F3C3FFB81E5857243CB351ED0471FA27047A2E4E18A6C0B0EDF6CA69359B3DE8CAF585563EAE45CBF0992674FA793F77BCF736E3C52418591D02A0923F2171290C849C8E6839324240A521A2413B6D03AD756FAB76C8D6293CEB7E9E49D73FF9604B7C9DDC594FE3B9DBC76EFC9A67C52F4E063E0D2E9492B25D19E487AC8B55A8F07D7FE3B67978DFC15F1B2D7F19DBBCB670E37AC5FCA92AFA3D0BF0A3D013D45812FAB701FAD539E4255A96B27BA4DA961FBF9C189D69430B2AF6C69B0BF75215D9F9992A6FDFE1BD566EED65DE77321DC071B240B4045901B69791D63F24AA63CAEF637F13A726F087678B80A204F8D723A5E9A854D79B8268E8FEC7D5514EC775142D7E3B298ACAFE7B35A592B5578392DDBA9EEBCF6A3CA3E4095CDB5FA69E5FE5635FB32A46237A7F1B9031A9FAEC2C4B61BF6243E5D87BBB7646BDD936EC87C70D7E9ACF8A247A19A0EA31FCC6981AA8D37F2BA5BEA4BC5A55EEA4B2DD8D1525F50952FF1C24B41078B258C4D917CB4A1FED5AF2572145E0A32144BC8E4875E1E5831B55B226A0A8FCB4487CBC4F353CD2A51FC365421736F77E7D869210ABB6F4693996E04341A4DA257B07D7FEB0644AE2F6A9A7919465B345F09BA8C7F6FAAC9149B3F432DCBCB0DD6C3DD6F9C9846B49B265D599588F19B25B476CE07BC9D5E4EEB3E6A64138D9CB663A7D6E6D68A71614D61694DA1C074A632B23F0241EC249DCB2764E806C9977963DEE58F446BA7786EAA1D168A861762C30BA0E18571C34B45C34BB1E125D0F0B26BABD86015117A04AC32DD6BEA8CBC5647C3A504EDAC286AA597B3416A6D30A7951F35B38966763C5A6ABFB13D9BF0C2E0B6133A4E27DDB9767D12278EBF6304F9FD9F8DC9BCF6DCDBBB6440252DD8409CF2EE4D49CB1B5E18379C4B0CD242D5DB2FC534AF3BC2BD125425FFBEF7D5432E91A59D7663C4D34EC355041EB59C8996A36B53626980A62AE5DAF93B596EB7764A2525B44A9C28C9AD055B52AF828D3DA1AC3F6F5EDA4948B406ACEDE5D44FD3E129C60712D0F5EE01A19E9882521D55BD17F484B490F14167AE1EED54A8A2670D15DBBDB529B70B19E557775A5354580774E54DD70595F7B1F4124A3B2EBC14BA2A96B03B4F6630D9D23CAE283CAE1E26AB47365D623B4D76459C380D24529C4AF7732C0DD9B0AD9528DAC4C3EB5085B1272ADA569307D05DEDE69194D8E3943A7C178D956F845F38725B507E8AD7EE5870547F4D37514F1A2F8EFA6CA91B0DD4A1F1C15B505863A5FB93457BF78AE2ECB19B516126443F47903C0788D3CA566B456512B65B1D8AEA8FEB81C97A70F97EEFDF90A8832541B70278A1AA95B34E5A799FC9840233657CE870B5F9E5F06D7E70BDB0858D29882D9B2DA164213C8E98077C7CAA669DE4C358BB59190DF7B3FCEA07EF78B1DDAB0658D93DA694D8BD1A2350F7EA12E6E1655E28971C17E12C0EB3B48030CAF252568B1517D0DD6EC96A10795CB84C16AEB74E9C8C1396FCDA8DC66ABACB7D1418C1DB9F9A6EF711844665CBBF98E83EB215EC3C544615E76AD769D5D9694B8DC92B75B55E6D778ECA88BAE5396A45E151579AE8CA974E5205C82EDCC0891E70CAAA8F4FEC0C63C5056F30184DDEDDA75B56935ED161FDE75AD05C9AC771B876B37EB247E35FE61C5A5F059B0910D890AF5495EF9D02804E0C7747A7026D8FEEBF04018AB42A7D56D3CA0F1D9AA4FE2490A233854429541DEF924A9ACE434A509C566EB076778E27E7802B8E9C87A9482BC2FC9B97644782740AC9F9C4B49847478A6D56A439ADA093C4F98C196A0C02161A042C3A44C06214042C0647C0C204018BF1102075F94043A8F6A1D7E3C9EC51797CF03C2E8397C4230999CCD769AFA865E6C46B6723AE1354AB6D8CFA25C119EBD5EA056D2A010D003D951C30CD33EEC6B1C1986917C47837832510103C3D39E91F85CD28388DD2EC1E7BAC5086851DCBF831204EE76F82C61AED7CAAC71EF09E0CA220D1813A8809D4115C91121C00BE48E1607A0244D18D026DF1C0184287E2F4B8C643750A80B7F8145156C3E10C646E00648102C0B45D854F8EB33310B6D8A05D0FEFB799858F39B71944E329BE18AF7B551E1EF4B3F380E432C41E04E21ED3367BA83B36F69A672788C1060E523048CC2C43C5FE557B445B37C21DF9F48D2F29D3C3C24C2A92A3409BFCB01B4281E6E41B09819E949EC691A95DCC3B42A6524603C05229061C26CB8888512DB7DA97AEB3B0248EF51683ADA26BAAE4A4CAD4CA8013FA32A00127C817D376332266C4F3DDA5E67C77D9E1F9EE7294F3DDE5E0E7BB4B13142EC743802270131A48CC87E4EAB1ED6979C384971A9EB7748442BDC80600A65E3CA86D27171A3F8EDEE2D232803A07CAF4C3E831264CDBCCDE87F23F0CA3D7E49C0DA1DFE47CA3EC26598694B10164A6FCF0998E301043E2EB20751A5612C342D25ABFB19FEB8C024D3145188410455646DD19960A788A3464184C77042F90B901F0044A00D37699E76F14F0C8338E4223ADC9345E8F361F86398839A7498E3AD031AD524603605129054CFB7C3CEF21E012A1DC1059E50F0B9F23EB4BADBC86C76A3BFD79887835B311CDAE10382C141FA4A96922D0E1616E6D721E22E2718E35DCC5128785F08370CE6104373C925B3BE90E11C13A4F9DEE72113C6AE1AD94EE03D1A13C6E6A5E87075A0B9FDB0810CBBF93A075125A834465387E1079C58568C217461F63527C6414175FDFF1C8482952CE81CFDBEA2F3300E809486BD22B7742029DF285A63E6BA50A34D8971A3AF9C1A740217FACEB43EE58129BCF9F6B6A33E1620205E69DAE0F4C20B8D811E6A5860E6024092481721AEA95CE10E8556F3414B8A54EA0C3BDD7498D099D11A5C6BCE4E830D38F83419A489579CBE558E53500FC6552D5D30A5E82FA803F45622A4B013C6BF61FCDDB02E66DA1E56D61C3DBA247DEE439C24446F51F96343AAEFCB484E1029CE37A6A129928A6BA9564F271520A45FCC001E2A0F189838D281A5F25E860D54200DAE44DA2408CE2EF1B7C6123F0193E515AD8A8118930E145C85CA0929C1FA2083571DE0D7EE0486F86036071D110EA5914924F7E25CA551DB4DCD49460D8323B33C0454D434B220DC044B31205B77E2B25A2D8F143CCC8F7FB56F291EFCE19926A93C45C5A402E0351548838D00653EA48502C470892122141F65F7B15C3E4ED81550C109028D50C6248624B1523C620F688962AA73C64B92DB596DBD2C6725BF668B9A972F889EC6203C71A4C2042C7347C61C949C484DB64B5C0047F478C041BAA78A5E63003114B2C56C07DB892528FDB196D2A4BA5444C41840EC1B192D9E8B0925C15278A51132CD2600E0E17D15A211A3AB23D037C58642E0AE01E55511C88F007D5F92C6CE8A9CFE11034FB34F81497336A4584428EDE17DF89A8C643145A6D99FB85DB7B863B91E9E86A4C9D9E4D2B61ECAE04E589EC44A283EF50A03CA45AD9E9F7281A1F5827F2EA749B5226AFAA9C32D5BBF3D96A7D477CA778703EA345D66497505867DE9AB87C41D5EECE0D6EE3BA66F164B2DA39EBB4FFDFADA6937BDF0BE28BE95D92EC5ECC6671463A3EF1DD7514C6E136395987FECCD984B3A7A7A73FCDCECE667E4E63B68E5971F32EA4AA25BA5D716E09F73615DD8664A91FD36C6A374E9A0EED72E30BC56A171470205FB623F5328923571ED597D5D2FF0B679722539E9A6C2DD7D794553F75056619E6604C09042889D5DAF19C4892D6EE32F4F67E00FB26E1DA79564DB67EFE44A4703EE338105C8E82E884A884E680A0860BB45ADA0D939C1C6278A08A630F0B44E1D3CAFD8D23513CC2D3F82CD2F86C4AE3D3559A68B8D18DEC89412F040A9F0D297CBA0E776FC996EF47F5D4A02F524A9F5B5062BFE46669A9BEF086A9F1F1002C455DACC068535B696DB79BDE3049C41457553ED4693EF776774E9344F1084FA38CD167894071FB3095A3842070FED40E7C326208D8C9ABF503B8949166FDFC8901E084C19567E484292C040AF28C8E3085A54041FECD304C41FAED5D430D633ECE1B4F7302FEF0964A53460DA32FE5F5FA416E7D7B334BA37E8AA7C45CE0CC92621E1BD07264BDAA9F1ACCCCFA1EE7C6F4AC1FE369317902595A8AF481A32159E5876F8766902202D18ABAFDA0BAB8AD9725503C32434E755D2F8F9DEA85193DE6D65E9E22F3CA8CE6ABF2FA5E9E62F5024FAFBAC597A5553DC4D3015210B25491590A15BC97A9E91A7C43F9EAC65B535481672D1716902466755154EE673296979F36EC80E299C1942EAE3F6DCCE9E2D937A9C2B1C7FEED3084A28E801392CEA1EEF3EC7657A06AE2D29734349426B5094C954D1A20B1A90F0BBDB05BA01D5E017A08848235FBC164750F61034AE543136466F70C3601993D32991FA9248B5B049BD3847961B049BDE4B6A8976647736542BBE6C11C94E64EC5179BD4ACC9982ADD994ADA4778CAA2735BB69B694AAA88F9A6A9DFCFACAB2F516369D44F0D2C84FA52B48685503F1E7B756977C43D96F95B07E77666FE822431E6AFA2723FD0CCEFAC62EBE74F061E22C1A9CD17A95A2F9E54BF2BA776E1506E78BA33AE53BF75C66D5C38B7790F735E643AA1A2F9EA6E52EFF2EA214E887F92163859FDC3BBF45C92C6A69605DE3981BB2571925F6D367D7A7AF6743A997BAE13E7510885EFFC05FF7124CA997EF62C75A6938D3FE3AB9BBBE4532A71BC6938C9C51BE3544EE8216E66CBE27EB577AF195FB65BDF1C197CA546E89D13FDC177EEFFA8A184BE674F9A58E8FF4D5A22A5C2DF9C93DA7AA1931893F86C4F2277375B75C29A42ED6AB6EA472754C45B483318095F6FBF0936E4FE62FACFACDA8BC99B4F5FEA9A4F26CB882ABF1793D3C9BF3ABA5215DB89666D838EE06FCD84D2317D0B33BA98D0C27DF3A637AFE73E66A6D386044AFFB2D9E0E7B5BE69F44932B81E2BEE72D7727B8CCC5B0CD0DC161F8B168D2E6C1B5DB6687469DBA8D4C56DB8228824A02EE5B76FB753C892EBED8E754ED40E6B9B359CF1555B9171BAE80CE3A2CEC9DCB8B76DA63BE3DB30436155B107EC41F7811D2BFE0AEF727BA5DC702A5B8D37E74CB6A655B991AD28554EE4F622023CC666A09612B1D2F795CBD9AC2345B55E2C6DE812DD639D5DA5B7B83D764A4FB1CA5A3737D7FB53AD36C38FC9237AAC48E861CF35D2CE45A24838CFB0A13E69D4EEC2826D6FB8F6046C79B2C5638572E513C6A25934B76460CE5CC430C93363920D5F7117E797A9D7B80B3AB5E7D8F4BC2DAF6735479A8E66B30EB075F1B6F5C1682EF47C55A5F73DD6595BBB94BB8030E355EE82DCC12C657D1E86DB9C7800CEDFA34563EE49AEB4FD8D1B38D1838D0F0EBABD8FCB83C9A70CB2BBB48FDD5E0E7255DF5017A1A1DA917FE733E0CD8C8BC7B1ED6B6CE55F600D32B6FAD4A7B2FC9C8DA1629E0E735D3A930895C51CF3B817DCA83E6DE91C3BCAE07DB1354564FAD03092B80B5A2328BBF6B01F10E174D6514207ADDFC6468D51465D5DAA5BF31B617A829621C63B8218F64B8DCEE166866DE4F75C83DE5DAE075C951C881950E0960C9595330E32E06F2246C602F815DE3056AD3A01B334257073C1601E0FA258CA247D4C1F7ABD6E501941DD3976C0DC40624BAA10F6A1B183BB9CCA18429A0B9FB9BC6E0CC9216E8C1A1618BA2F4D0E101F88FCDCF683D993963158EB3A8293F9005B22CA6445843F3C1BD44601D299DBA348A3681ED1D0684AFDE1E080A771CBC7D338C361469FC6C9B3190D32B6D844F6A663D5D352D1D13EBC2324A107D81248ED77DABA8FFA87D11FAAFCFFD2FCF3C8CBA3352BC9A04A459588703CCD824A6B363408CCD48D312A5490382CFD312C68DA6B1155228F41C0A3B9E8A1CD89850A25C690EB080F060712B627F666C883B2838E71B3B1E6E88C4FD5CE8CDF28F76F0F7D84A6CD4B3EE631DA21DE948D502A8786A9B1F4D3F0D832D45387882F336BE7D0A0765806D3F0006C6F341D221671AE8343C3E0B8AE87E131677E1E798858D3F9202C50764887C7C3C3C3E4F478046070D99CAA8EF077FBF0435824889282A9BC374981913C93D3C5747313D2D1CFE38BD5D736096D9676B9D056F942D606708F1D4F9BB5CD04FAEC4B591B8ACBDFF876F2232EA185FCB18C76FA06C5407EA42FF63D7F2EED76FA0A439B894711E833EF646DC0B7680B0C30D19A2217CC4B292BCC7B4D3B803D2434099493B58EBB9D8EEF48A5F784A6AB37B2C6A06BC978F2DCDA2B34C2BD9735A5BE2B4E18402674411C40E6A57400C1BBB855571DCFE1AB8EE782AD2338C42A0630371CB31377D5E5F5B445283DC8C8E2481891C68D4BB8D2C79737BA2BE89E55F3620015ABA24A597199CC3B653B17BD9263E09E904E98C561A1058BBAA05C09CB4671BC980D2DC3164ADBDA88D5E2227AA55034D1A5724399E930E6DEF9FE5915A32465AA4B1D4AD904AEB06EACB884AB2A869B46E1AAD3AB8BC1A03E35C7D85B61ED1897AEEFAB3EAE7895C7AE4964800872EB8285B613C5625ED7C1568A790D44641D19CB65341168902C8FC4205184CE4878C306DA9877BD8FE5ADCDB872511EB2F1550582801E0E76B0C18DF030B6B42E8641CDB3E9E8DB09613C2488DE7A895C342EFD766BB09DF8EC6F27870D1684135B793ACA30607019799FC60BEC46D5B38F1AF56E4430020AD0BAC1DC53D88380C6D3134AE7945E5C5833B81B310D670E037E14BD40F4067137A2E8C63E14EE7DA8DE9DCFF213BCE201FD29DCEF703EBBDAD3DA7E9E23E4FC2589DDDB9AC439A5199075C333519579136CC3D251C2F5A82CC2E7AE2689B37112671E25EED65927F4F59AC4B11BDC4E27BF3ADE9E1679E5DF90CD9B60B94F76FB84B24CFC1BAF718351EA6851B57F3E13FA7CBEDCA5BFE22E58A0DD74290B64192CF6AEB7A9FAFD5A92810520917A708A0C31E9582669A698DB878AD2FB9037B1204285F82AC7D335F1771E25162F8395F395B4E9DBC798BC25B7CEFAA1BCA60326A21F88A6D8CF5FBACE6DE4F87141A3AE4F7F520C6FFCFB9FFF07D1B786B7ED0A0100, N'6.1.3-40302')";
            RunDBTransaction(str);
        }

        /// <summary>
        /// Generic function to execute an SQL transaction
        /// </summary>
        /// <param name="sql"></param>
        private void RunDBTransaction( string sql)
        {
            using (var context = new AnrlModel())
            {
                using (var dbContextTransaction = context.Database.BeginTransaction())
                {
                    try
                    {
                        context.Database.ExecuteSqlCommand(sql);
                        context.SaveChanges();
                        dbContextTransaction.Commit();
                    }
                    catch (Exception)
                    {
                        dbContextTransaction.Rollback();
                    }
                }
            }
        }

        /// <summary>
        /// Check if the database is an old database without version (__MigrationHistory table)
        /// </summary>
        /// <param name="context"></param>
        /// <returns></returns>
        private bool IsOldDBWithoutHistoryTable(TContext context)
        {
            string str = String.Format(@"IF NOT EXISTS {0} AND EXISTS {1} SELECT 0 ELSE SELECT 1", CON_SQL_Check_Existence_MigrationHistory, CON_SQL_Check_Existence_CompetitionSet);

            object[] obj = { null };
            DbRawSqlQuery qData = context.Database.SqlQuery(typeof(int), str, obj);
            foreach (var item in qData)
            {
                if ((int)item == 0)
                {
                    return true;
                }
            }
            return false;
        }
    }
}

